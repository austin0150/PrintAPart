<!DOCTYPE html>
<html lang="en">
<link rel="shortcut icon" type="image/jpg" href="images/faviconImageClear.png">
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <%- include('../partials/head'); %>
</head>

<header>
    <%- include('../partials/header'); %>
</header>

<body >
  <main>
    <div class="container">
      <h1>Enter Profile Info</h1>

      <form method="POST" action="/add_user">
        <div class="form-group" style="width: 45%;">
            <input type="text" class="form-control" id="userName" name="userName" placeholder="User Name" required="true">
        </div>
        <div class="form-group" style="width: 45%;">
            <input type="text" class="form-control" id="userFirst" name="FirstName" placeholder="First Name" required="true" onkeyup="updateUserName()">
        </div>
        <div class="form-group" style="width: 45%;">
          <input type="text" class="form-control" id="userLast" name="LastName" placeholder="Last Name" required="true" onkeyup="updateUserName()">
        </div>
        <div class="form-group" style="width: 10%;">
          <input type="text" class="form-control" id="userZip" name="ZipCode" placeholder="Zip Code" onkeypress="return isNumberKey(event)" maxlength="5" required="true">
          <div class="invalid-feedback">Please provide a number for ZipCode</div>
        </div>

        <div class="form-group" style="width: 55%;">
          <p>Choose your profile picture</p>
          <input type="file" class="form-control-file" style="font-size: 16px;" id="userProfileImg" >
          <progress id="profileUploaderBar" class="d-none" max="100"></progress>
        </div>

        <input type="hidden" name="uid" value="<%- uid %>"/>
        <input type="hidden" name="email" value="<%- email %>"/>
        <input type="hidden" id="ImageLink" name="ImageLink" value="https://firebasestorage.googleapis.com/v0/b/printapart-d7319.appspot.com/o/profile_images%2FplanetProfile.png?alt=media&token=70933600-0b04-4927-8971-fa875c490454" />

        <button class="btn btn-primary" id="submitBtn" type="submit">Submit</button>
      </form>
    </div>
  </main>



  <script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script>
  <script>

    // Initialize Firebase
    var config = {
      storageBucket: "gs://printapart-d7319.appspot.com"
    };
    firebase.initializeApp(config);

    var profileImgBtn = document.getElementById('userProfileImg');
    profileImgBtn.addEventListener('change', async function(e){

      var file = e.target.files[0];

        if(file == undefined)
        {
            return;
        }

        await uploadImg();
    });

    function isNumberKey(evt){
      var charCode = (evt.which) ? evt.which : evt.keyCode
      if (charCode > 31 && (charCode < 48 || charCode > 57))
          return false;
      return true;
    }


    function updateUserName(){
      firstInput = document.getElementById("userFirst");
      lastInput = document.getElementById("userLast");
      userInput = document.getElementById("userName");

      if(lastInput.value == "")
      {
        userInput.value = (firstInput.value);
      }
      else{
        userInput.value = (firstInput.value + " " + lastInput.value[0]);
      }
      
    }

    // This function 
    async function uploadImg(){

      var progressObj = document.getElementById('profileUploaderBar');
      if(progressObj.classList.contains("d-none"))
      {
        progressObj.classList.remove("d-none");
      }
      var fileBtn = document.getElementById('userProfileImg');
      var file = fileBtn.files[0];

      var date = new Date();
      var time = Math.round(date.getTime() / 1000);
      var storageRef = firebase.storage().ref("profile_images/<%- uid %>_" + time +"_"+ file.name);

      var task = storageRef.put(file);

      task.on('state_changed', 
      function progress(snapshot) {
          var percentage = (snapshot.bytesTransferred/snapshot.totalBytes)*100;
          progressObj.value = percentage;

      }, 
      function error(err) {
          
      });

      await task;
      var url = await storageRef.getDownloadURL();
      document.getElementById('ImageLink').value = url;

    }

  </script>
</body>

<footer>
    <%- include('../partials/footer'); %>
</footer>
</html>